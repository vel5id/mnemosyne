<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnemosyne Observability</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --redis-color: #dc2626;
            --sqlite-color: #0ea5e9;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }
        
        .card h2 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .card h2 .icon { margin-right: 0.5rem; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .metric:last-child { border-bottom: none; }
        
        .metric .label { color: var(--text-secondary); }
        .metric .value { font-weight: 600; font-size: 1.1rem; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-offline { background: var(--error); box-shadow: 0 0 8px var(--error); }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .breakdown-chart {
            display: flex;
            height: 20px;
            width: 100%;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .chart-segment {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .legend {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th {
            text-align: left;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        tr:last-child td { border-bottom: none; }
        .tag {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.3rem;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>üß† Mnemosyne Observability</h1>
        <p>Hyper-RAM (v4.0) Status</p>
    </div>
    
    <div class="grid" id="dashboard">
        <!-- Rendered via JS -->
    </div>
    
    <script>
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                console.error(error);
            }
        }
        
        function renderDashboard(data) {
            const sys = data.system;
            const db = data.database;
            const redis = data.redis;
            const analytics = db.analytics || {};
            const sessions = data.sessions || [];
            
            // Calculate Pipeline Breakdown
            const total = analytics.telemetry_events || 1;
            const p_telemetry = ((analytics.telemetry_events || 0) / total * 100).toFixed(1);
            const p_llm = ((analytics.llm_events || 0) / total * 100).toFixed(1);
            const p_vlm = ((analytics.vlm_events || 0) / total * 100).toFixed(1);
            const p_screen = ((analytics.screenshot_events || 0) / total * 100).toFixed(1);
            
            // Build Sessions Table Rows
            const sessionRows = sessions.map(s => {
                const tags = JSON.parse(s.generated_tags || "[]").map(t => `<span class="tag">${t}</span>`).join('');
                return `
                    <tr>
                        <td style="color: var(--accent)">${s.time_ago}</td>
                        <td>${s.duration}</td>
                        <td><strong>${s.primary_process}</strong><br><span style="font-size:0.8em; color:var(--text-secondary)">${s.primary_window.substring(0,40)}...</span></td>
                        <td>${s.activity_summary || 'Processing...'}</td>
                        <td>${tags}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dashboard').innerHTML = `
                <!-- Recent Sessions (New) -->
                <div class="card full-width">
                     <h2><span class="icon">üé•</span> Recent Sessions (AI Summarized)</h2>
                     <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Application</th>
                                <th>Summary</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessionRows.length > 0 ? sessionRows : '<tr><td colspan="5" style="text-align:center; padding: 2rem; color: var(--text-secondary)">No sessions recorded yet. Wait for Brain to analyze activity.</td></tr>'}
                        </tbody>
                     </table>
                </div>

                <!-- Live Perception Log (New) -->
                <div class="card full-width" style="border-top: 2px solid var(--accent)">
                     <h2><span class="icon">üìú</span> Live Perception Log (Last 20 Events)</h2>
                     <div style="max-height: 400px; overflow-y: auto;">
                         <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Time</th>
                                    <th>Process</th>
                                    <th>Window Title</th>
                                    <th>Intent (AI)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderLogs(data.logs)}
                            </tbody>
                         </table>
                     </div>
                </div>

                <!-- Knowledge Graph Stats (Enhanced) -->
                <div class="card" style="grid-column: span 2;">
                     <h2><span class="icon">üï∏Ô∏è</span> Knowledge Graph</h2>
                     <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                         <!-- Summary -->
                         <div style="flex: 1; min-width: 150px;">
                             <div class="metric"><span class="label">Total Nodes</span><span class="value">${(data.rag && data.rag.nodes) || 0}</span></div>
                             <div class="metric"><span class="label">Total Edges</span><span class="value">${(data.rag && data.rag.edges) || 0}</span></div>
                             <div class="metric"><span class="label">Last Updated</span><span class="value">${(data.rag && data.rag.last_updated) || 'N/A'}</span></div>
                         </div>
                         <!-- Breakdown by Type -->
                         <div style="flex: 1; min-width: 150px;">
                             <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Node Types</div>
                             ${renderBreakdown(data.rag && data.rag.breakdown)}
                         </div>
                         <!-- Concepts Cloud -->
                         <div style="flex: 2; min-width: 250px;">
                             <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">üß† Extracted Concepts</div>
                             <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                                 ${renderConceptTags(data.rag && data.rag.concepts)}
                             </div>
                         </div>
                     </div>
                     <!-- Recent Sessions with Summaries -->
                     <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                         <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">üìù Recent Session Summaries</div>
                         <div style="font-size: 0.85rem; color: var(--text);">
                             ${renderSessionSummaries(data.rag && data.rag.sessions_with_summary)}
                         </div>
                     </div>
                     <!-- Event-Level Details (Variant 3) -->
                     <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                         <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">üî¨ Event-Level Details</div>
                         <div style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                             ${renderEvents(data.rag && data.rag.recent_events)}
                         </div>
                     </div>
                </div>
            `;
        }
        
        function renderLogs(logs) {
            if (!logs || logs.length === 0) return '<tr><td colspan="5" style="text-align:center; color: var(--text-secondary)">Waiting for events...</td></tr>';
            return logs.map(l => {
                const timeStr = l.time ? (l.time.includes('T') ? l.time.split('T')[1].split('.')[0] : l.time) : '--:--:--';
                const windowStr = l.window ? l.window.substring(0, 50) : '';
                return `
                <tr style="font-family: monospace; font-size: 0.85rem">
                    <td style="color: var(--text-secondary)">#${l.id}</td>
                    <td>${timeStr}</td>
                    <td style="color: var(--accent)">${l.process || 'Unknown'}</td>
                    <td title="${l.window || ''}">${windowStr}${windowStr.length >= 50 ? '...' : ''}</td>
                    <td style="color: ${l.intent === 'Unknown' || l.intent === 'Processing...' ? 'var(--text-secondary)' : 'var(--success)'}">${l.intent}</td>
                </tr>
            `}).join('');
        }
        
        function renderBreakdown(breakdown) {
            if (!breakdown || Object.keys(breakdown).length === 0) return '<div style="color: var(--text-secondary)">No data</div>';
            const icons = {Session: 'üìÅ', Application: 'üíª', Concept: 'üí°'};
            return Object.entries(breakdown).map(([type, count]) => 
                `<div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
                    <span>${icons[type] || '‚óè'} ${type}</span>
                    <span style="color: var(--accent); font-weight: 600;">${count}</span>
                </div>`
            ).join('');
        }
        
        function renderConceptTags(concepts) {
            if (!concepts || concepts.length === 0) return '<span style="color: var(--text-secondary)">No concepts extracted yet</span>';
            return concepts.map(c => 
                `<span style="background: linear-gradient(135deg, var(--accent), #6366f1); color: #fff; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">[[${c}]]</span>`
            ).join('');
        }
        
        function renderSessionSummaries(sessions) {
            if (!sessions || sessions.length === 0) return '<div style="color: var(--text-secondary)">No summarized sessions yet</div>';
            return sessions.map(s => 
                `<div style="padding: 0.3rem 0; border-bottom: 1px solid var(--border);">
                    <span style="color: var(--accent); font-family: monospace; font-size: 0.8rem;">${s.id}</span>
                    <span style="margin-left: 0.5rem;">${s.summary}...</span>
                </div>`
            ).join('');
        }
        
        function renderEvents(events) {
            if (!events || events.length === 0) return '<div style="color: var(--text-secondary)">No event details captured yet</div>';
            return events.map(e => 
                `<div style="padding: 0.25rem 0; border-bottom: 1px dashed var(--border); display: flex; gap: 0.5rem; align-items: baseline;">
                    <span style="color: var(--success); font-weight: 600; min-width: 70px;">${e.process}</span>
                    <span style="color: var(--text-secondary); min-width: 100px; font-size: 0.75rem;">${e.window}</span>
                    <span style="color: var(--text); flex: 1;">${e.intent || '...'}</span>
                </div>`
            ).join('');
        }
        
        // Loop
        fetchStatus();
        setInterval(fetchStatus, 2000); // 2s refresh for realtime redis feel
    </script>
</body>
</html>
